{"componentChunkName":"component---src-templates-blog-post-js","path":"/moco/","result":{"data":{"site":{"siteMetadata":{"title":"Xiu's Blog"}},"markdownRemark":{"id":"598eded9-6c60-51c9-9d11-74423cee61ee","excerpt":"2020.03.31 Update: MoCo 代码已开源， 发布于 https://github.com/facebookresearch/moco. 上个月 Kaiming He 发了一篇关于无监督表示学习的文章 Momentum Contrast for Unsupervised Visual…","html":"<p><strong>2020.03.31 Update:</strong> MoCo 代码已开源， 发布于 <a href=\"https://github.com/facebookresearch/moco\">https://github.com/facebookresearch/moco</a>.</p>\n<hr>\n<p>上个月 Kaiming He 发了一篇关于无监督表示学习的文章 <a href=\"https://arxiv.org/abs/1911.05722\">Momentum Contrast for Unsupervised Visual Representation Learning</a>，提出的方法在多个 detection/segmentation 的下游任务上取得了非常好的结果，用文章的原话说甚至是 “the gap between unsupervised and supervised representation learning has been largely closed”。我在 11.23 于 CUVL 的 reading group 上 present 了这篇论文，在此贴上当时做的 slide 并简单分享下核心思想。</p>\n<p>此文继承了 Kaiming 一贯方法简单却能取得非常好的结果、令人意想不到的风格。其实这篇论文非常的工业界，就是对之前 instance discrimination unsupervised representation learning 方法的一些不足之处作出了改进，可以说是站在了巨人的肩膀上。相关论文可以看看 CVPR 2018 的 <a href=\"https://arxiv.org/abs/1805.01978\">Unsupervised Feature Learning via Non-Parametric Instance-level Discrimination</a> 和 CVPR 2019 的 <a href=\"https://arxiv.org/abs/1904.03436\">Unsupervised Embedding Learning via Invariant and Spreading Instance Feature</a>。尽管该工作的 novelty 可能是比较有限，更像是发明了几个trick，但必须指出这不能否认他的 contribution 是巨大的，称得上是 unsupervised learning 这个方向的一个突破。</p>\n<p>所谓 instance discrimination learning，就是把每个 instance 当成一个单独的 class 进行学习，所采用的方法通常是维护一个字典并通过 contrastive loss 来训练编码器：</p>\n<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"script\">L</mi><mi>q</mi></msub><mo>=</mo><mo>−</mo><mi>l</mi><mi>o</mi><mi>g</mi><mfrac><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mo stretchy=\"false\">(</mo><mi>q</mi><mo>⋅</mo><msub><mi>k</mi><mo lspace=\"0em\" rspace=\"0em\">+</mo></msub><mi mathvariant=\"normal\">/</mi><mi>τ</mi><mo stretchy=\"false\">)</mo></mrow><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>K</mi></munderover><mi>e</mi><mi>x</mi><mi>p</mi><mo stretchy=\"false\">(</mo><mi>q</mi><mo>⋅</mo><msub><mi>k</mi><mi>i</mi></msub><mi mathvariant=\"normal\">/</mi><mi>τ</mi><mo stretchy=\"false\">)</mo></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\mathcal{L}_q = -log\\frac{exp(q \\cdot k_{+}/\\tau)}{\\sum_{i=0}^K exp(q \\cdot k_i / \\tau)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathcal\">L</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.03588em;\">q</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.597941em;vertical-align:-1.170941em;\"></span><span class=\"mord\">−</span><span class=\"mord mathdefault\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathdefault\">o</span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.427em;\"><span style=\"top:-2.128769em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.981231em;\"><span style=\"top:-2.40029em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathdefault mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.2029em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.29971000000000003em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathdefault\">e</span><span class=\"mord mathdefault\">x</span><span class=\"mord mathdefault\">p</span><span class=\"mopen\">(</span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\">/</span><span class=\"mord mathdefault\" style=\"margin-right:0.1132em;\">τ</span><span class=\"mclose\">)</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">e</span><span class=\"mord mathdefault\">x</span><span class=\"mord mathdefault\">p</span><span class=\"mopen\">(</span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.25833100000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">+</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mord\">/</span><span class=\"mord mathdefault\" style=\"margin-right:0.1132em;\">τ</span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.170941em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span>\n<p>此处 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">q</span></span></span></span> 是一个 instance 通过编码器后的 query 表示，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>k</mi><mo lspace=\"0em\" rspace=\"0em\">+</mo></msub></mrow><annotation encoding=\"application/x-tex\">k_{+}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.902771em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.25833100000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">+</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span> 表示相匹配的 key，通常是另一个具有相同语义的 instance 的编码（此处可以是同一张图片不同的 data augmentation），而分母中的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>k</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">k_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 均是不匹配的 key。该损失函数在不同 instance 编码后差异越大，相同 instance 编码后差异越小时函数值越小。这样预训练好的编码器可以提取图片的 representations，通过微调迁移到 detection/segmentation 等各种下游任务上。</p>\n<p>本文主要贡献即是对于字典的更新提出了 MoCo 这一方法，通过 momentum 的机制平滑更新生成字典的编码器，既避免了 end-to-end 方法受制于显存大小在作 contrastive training 时无法 scale 影响 performance，也解决了 memory bank 线下字典过时的劣势，很好地平衡了字典大小和质量的 trade off。正是此方法使在超大数据集上做这样的预训练成为了可能，而 Kaiming 团队也对 MoCo 预训练模型提取的表征针对多个下游任务作了迁移学习相关实验，取得非常好的结果。具体细节参见 paper 和我演讲的 slide。</p>\n<p>本人对 representation learning 了解不多，也就不再此更深入地分析了。除了以上提到的文献，大家如有兴趣也可以参考这个<a href=\"https://www.zhihu.com/question/355779873\">知乎问题</a>，最上面的几个回答都质量挺高，有一定 insight。总而言之此文的贡献还是非常有突破性的，为 CV 任务也能像 NLP 的 BERT 一样采用一套通用的 backbone 提取特征并运用到所有下游任务上迈出了重要的一步。不过正如某个<a href=\"https://www.zhihu.com/question/355779873/answer/895625711\">知乎回答</a>提到一样，我也认为负样本选取的随机性使得仅仅增大数据集的量级所带来的信息增益有限，如何更好地选取信息量大的样本可以是一个将来的研究方向，或许能结合聚类、active learning 中的方法着手。</p>\n<h3>Presentation Slide</h3>\n<!-- {% pdf https://lxywizard.github.io/files/CUVL_Reading_Group_11_23.pdf %} -->","frontmatter":{"title":"论文笔记：MoCo","date":"December 25, 2019","description":"上个月 Kaiming He 发了一篇关于无监督表示学习的文章 Momentum Contrast for Unsupervised Visual Representation Learning，提出的方法在多个 detection/segmentation 的下游任务上取得了非常好的结果"}}},"pageContext":{"slug":"/moco/","previous":{"fields":{"slug":"/cu-courses-review/"},"frontmatter":{"title":"康村课程记录"}},"next":{"fields":{"slug":"/continue-learning/"},"frontmatter":{"title":"连续学习介绍"}}}}}